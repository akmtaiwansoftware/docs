<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Exosite Documentation</title>

    <!-- Favicon -->
    <link rel="icon" href="/assets/favicon.png">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="/assets/less/style.css">

    <!-- Meta -->
    <meta content="Exosite Reference Documentation" property="og:title">
    <meta content="Developer Documentation for Exosite" name="description">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-44116002-2', 'auto');
      ga('send', 'pageview');

    </script>

    <!-- Initializer -->
    <script></script>

</head>
<body>
<nav class="navbar navbar-inverse navbar-static-top navbar-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-collapse"
                    aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div class="navbar-left"><a class="navbar-brand" href="/"><img src="/assets/exosite-logo.png" id="logo"></a>
            </div>
            <div class="navbar-text navbar-left text-uppercase"><strong>Documentation</strong></div>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="nav-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href='https://support.exosite.com'>Support</a></li>
                <li><a href='https://community.exosite.com' target="_blank">Developer Forum</a></li>
            </ul>
            <ul class="nav navbar-nav visible-xs">
                <div class="nav-links mobile-docs">
                    <ul class="nav navbar-nav">
                        <li><a type="button" data-toggle="collapse" href="#nav-murano-platform" aria-expanded="false">Murano</a>
                        </li>
                        <ul class="navbar-collapse collapse list-unstyled" id="nav-murano-platform">
                            <li class="menu-header">About</li>
                            <li><a class="level-0" href="/">Murano Overview</a></li>
                            <li><a class="level-0" href="/about/data-flow/">Data Flow</a></li>
                            <li><a class="level-0" href="/about/products/">Products</a></li>
                            <li><a class="level-0" href="/about/integrations/">Integrations</a></li>
                            <li><a class="level-0" href="/about/applications/">Applications</a></li>
                            <li class="menu-header">Quickstarts</li>
                            <li><a class="level-0" href="/quickstarts/">Quickstarts Overview</a></li>
                            <li><a class="level-0" href="/quickstarts/devicesensor/">Device Sensor Quickstart</a></li>
                            <li><a class="level-0" href="/quickstarts/lightbulb/">Lightbulb Quickstart</a></li>
                            <li><a class="level-0" href="/quickstarts/solutions/exampleapp/">Solution Quickstart</a>
                            </li>
                            <li class="menu-header">Tutorials</li>
                            <li><a class="level-0" href="/tutorials/">Tutorials Overview</a></li>
                            <li><a class="level-0" href="/tutorials/hvac-tutorial/">HVAC Reference Application</a></li>
                            <li><a class="level-0" href="/tutorials/esp8266-tutorial/">ESP8266 Thing Dev Board</a></li>
                        </ul>
                        <li><a type="button" data-toggle="collapse" href="#nav-services" aria-expanded="false">Services</a></li>
                        <ul class="navbar-collapse collapse list-unstyled" id="nav-services">
                            <li class="menu-header">Communication</li>
                            <li><a class="level-1" href="/reference/services/device">Device Gateway</a></li>
                            <li><a class="level-1" href="/reference/services/email">Email</a></li>
                            <li><a class="level-1" href="/reference/services/twilio">Twilio</a></li>
                            <li><a class="level-1" href="/reference/services/webservice">Custom API Gateway</a></li>
                            <li><a class="level-1" href="/reference/services/websocket">WebSocket Gateway</a></li>
                            <li class="menu-header">IoT</li>
                            <li><a class="level-1" href="/reference/services/device">Device Gateway</a></li>
                            <li class="menu-header">Storage</li>
                            <li><a class="level-1" href="/reference/services/keystore">Key-Value Store</a></li>
                            <li><a class="level-1" href="/reference/services/tsdb">Time Series Storage</a></li>
                            <li class="menu-header">Other</li>
                            <li><a class="level-1" href="/reference/services/config">Solution Configuration</a></li>
                            <li><a class="level-1" href="/reference/services/timer">Timer Service API</a></li>
                            <li><a class="level-1" href="/reference/services/user">User Management</a></li>
                        </ul>

                        <li><a type="button" data-toggle="collapse" href="#nav-reference" aria-expanded="false">Reference</a>
                        </li>
                        <ul class="navbar-collapse collapse list-unstyled" id="nav-reference">
                            <li class="menu-header">API</li>
                            <li><a class="level-0" href="/reference/products/device-api/http/">Device API - HTTP</a></li>
                            <li><a class="level-0" href="/reference/scripting">Solution Scripting</a></li>
                            <li><a class="level-0" href="/reference/services">Core Services Overview</a></li>
                            <li class="menu-header">Tools</li>
                            <li><a class="level-0" href="/development/tools/murano-cli/">Murano CLI</a></li>
                            <li><a class="level-0" href="/development/tools/deployment/">Solution Deployment</a></li>
                            <li><a class="level-0" href="/development/tools/exosite-cli/">Exosite CLI</a></li>
                            <li><a class="level-0" href="/development/exositeready/libraries-examples/">Libraries & Examples</a></li>
                            <li><a class="level-0" href="/development/exositeready/gwe/">Gateway Engine</a></li>
                            <li><a class="level-0" href="/portals/">One Platform & Portals</a></li>
                            <li class="menu-header">UI</li>
                            <li><a class="level-0" href="/reference/ui/create-account/">Create an Account</a></li>
                            <li><a class="level-0" href="/reference/ui/manage-business/">Manage Your Business</a></li>
                            <li><a class="level-0" href="/reference/ui/create-solution/">Create a Solution</a></li>
                            <li><a class="level-0" href="/reference/ui/create-product/">Create a Product</a></li>
                            <li><a class="level-0" href="/reference/ui/user-management/">Manage Users</a></li>
                            <li><a class="level-0" href="/reference/ui/keystore-service/">Record Product Metrics</a></li>
                            <li><a class="level-0" href="/reference/ui/external-app-hosting/">Host Your App Externally</a></li>
                            <li><a class="level-0" href="/reference/ui/device-management/">Manage Your Device Lifecycle</a></li>
                            <li><a class="level-0" href="/reference/ui/send-notifications/">Send Notifications</a></li>
                        </ul>
                    </ul>
                </div>
            </ul>
            <form id="searchForm" class="navbar-form navbar-right form-inline search-form">
                <!-- <a class="btn btn-warning" href="https://exosite.com/business/signup">Sign Up For Murano</a> -->
                <div class="form-group">
                    <input id="docsearch" onsubmit="return false;" type="text" class="form-control nav-search"
                           placeholder="Search...">
                </div>
            </form>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>
<div class="row main-row row-offcanvas row-offcanvas-left">
    <div class="hidden-xs sidenav sidebar-offcanvas">
        <h3 class="sidenav-header">Murano</h3>
        <ul class="list-unstyled">
            <li class="menu-header">About</li>
            <li><a class="level-0" href="/">Murano Overview</a></li>
            <li><a class="level-0" href="/about/data-flow/">Data Flow</a></li>
            <li><a class="level-0" href="/about/products/">Products</a></li>
            <li><a class="level-0" href="/about/integrations/">Integrations</a></li>
            <li><a class="level-0" href="/about/applications/">Applications</a></li>
        </ul>
        <ul class="list-unstyled">
            <li class="menu-header">Quickstarts</li>
            <li><a class="level-0" href="/quickstarts/">Quickstarts Overview</a></li>
            <li><a class="level-0" href="/quickstarts/devicesensor/">Device Sensor Quickstart</a></li>
            <li><a class="level-0" href="/quickstarts/lightbulb/">Lightbulb Quickstart</a></li>
            <li><a class="level-0" href="/quickstarts/solutions/exampleapp/">Solution Quickstart</a></li>
        </ul>
        <ul class="list-unstyled">
            <li class="menu-header">Tutorials</li>
            <li><a class="level-0" href="/tutorials/">Tutorials Overview</a></li>
            <li><a class="level-0" href="/tutorials/hvac-tutorial/">HVAC Reference Application</a></li>
            <li><a class="level-0" href="/tutorials/esp8266-tutorial/">ESP8266 Thing Dev Board</a></li>
        </ul>


        <h3 class="sidenav-header">Services</h3>
        <ul class="list-unstyled">
            <li class="menu-header">Communication</li>
            <li><a class="level-1" href="/reference/services/device">Device Gateway</a></li>
            <li><a class="level-1" href="/reference/services/email">Email</a></li>
            <li><a class="level-1" href="/reference/services/twilio">Twilio</a></li>
            <li><a class="level-1" href="/reference/services/webservice">Custom API Gateway</a></li>
            <li><a class="level-1" href="/reference/services/websocket">WebSocket Gateway</a></li>
        </ul>
        <ul class="list-unstyled">
            <li class="menu-header">IoT</li>
            <li><a class="level-1" href="/reference/services/device">Device Gateway</a></li>
        </ul>
        <ul class="list-unstyled">
            <li class="menu-header">Storage</li>
            <li><a class="level-1" href="/reference/services/keystore">Key-Value Store</a></li>
            <li><a class="level-1" href="/reference/services/tsdb">Time Series Storage</a></li>
        </ul>
        <ul class="list-unstyled">
            <li class="menu-header">Other</li>
            <li><a class="level-1" href="/reference/services/config">Solution Configuration</a></li>
            <li><a class="level-1" href="/reference/services/timer">Timer Service API</a></li>
            <li><a class="level-1" href="/reference/services/user">User Management</a></li>
        </ul>

        <h3 class="sidenav-header">Reference</h3>
        <ul class="list-unstyled">
            <li class="menu-header">API</li>
            <li><a class="level-0" href="/reference/products/device-api/http/">Device API - HTTP</a></li>
            <li><a class="level-0" href="/reference/products/device-api/curl/">Device API with Curl</a></li>
            <li><a class="level-0" href="/reference/scripting">Solution Scripting</a></li>
            <li><a class="level-0" href="/reference/services">Core Services Overview</a></li>
        </ul>
        <ul class="list-unstyled">
            <li class="menu-header">Tools</li>
            <li><a class="level-0" href="/development/tools/murano-cli/">Murano CLI</a></li>
            <li><a class="level-0" href="/development/tools/deployment/">Solution Deployment</a></li>
            <li><a class="level-0" href="/development/tools/exosite-cli/">Exosite CLI</a></li>
            <li><a class="level-0" href="/development/exositeready/libraries-examples/">Libraries & Examples</a></li>
            <li><a class="level-0" href="/development/exositeready/gwe/">Gateway Engine</a></li>
            <li><a class="level-0" href="/portals/">One Platform & Portals</a></li>
        </ul>
        <ul class="list-unstyled">
            <li class="menu-header">UI</li>
            <li><a class="level-0" href="/reference/ui/create-account/">Create an Account</a></li>
            <li><a class="level-0" href="/reference/ui/manage-business/">Manage Your Business</a></li>
            <li><a class="level-0" href="/reference/ui/create-solution/">Create a Solution</a></li>
            <li><a class="level-0" href="/reference/ui/create-product/">Create a Product</a></li>
            <li><a class="level-0" href="/reference/ui/user-management/">Manage Users</a></li>
            <li><a class="level-0" href="/reference/ui/keystore-service/">Record Product Metrics</a></li>
            <li><a class="level-0" href="/reference/ui/external-app-hosting/">Host Your App Externally</a></li>
            <li><a class="level-0" href="/reference/ui/device-management/">Manage Your Device Lifecycle</a></li>
            <li><a class="level-0" href="/reference/ui/send-notifications/">Send Notifications</a></li>
        </ul>
    </div>
    <div class="main content">
        <h1 id="manage-users">Manage Users</h1>
<p>Murano user management supports user authentication, role-based access control, and storage per user. This guide will give simple examples for managing users under your solution with <a href="http://docs.exosite.com/reference/services/user/">User Management Service</a>.</p>
<h1 id="prerequisites">Prerequisites</h1>
<ol>
<li>You will need a solution to follow these examples step by step.</li>
<li>You will need to install Murano CLI [<a href="https://github.com/exosite/MuranoCLI">https://github.com/exosite/MuranoCLI</a>] to deploy your solution.</li>
<li><p>You will need to add the following functions to &#39;my_library&#39; of MODULES for reuse. Use Murano CLI to syncdown your solution, then put this code into <strong>modules/my_library.lua</strong></p>
<pre><code class="lang-lua"> function find_user_by_email(email)
   -- This function is for finding user by email, which makes use of the filter of user listing operation.
   local result = User.listUsers({filter=&quot;email::like::&quot;..email})

   if tostring(result) == &quot;[]&quot; or result[1] == nil then
     return nil
   end

   return result[1]
 end

 function get_current_user(request)
   -- This function is to get current logged-in user, which is saved by token in browser cookie.
   local headers = request.headers
   if type(headers.cookie) ~= &quot;string&quot; then
     return nil
   end
   local _, _, sid = string.find(headers.cookie, &quot;sid=([^;]+)&quot;)
   if type(sid) ~= &quot;string&quot; then
     return nil
   end
   local user = User.getCurrentUser({token = sid})
   if user ~= nil and user.id ~= nil then
     user.token = sid
     return user
   end
   return nil
 end

 function random_capital_string(length)
   -- This function is a simple way to create password or token for example use. For your online solution, please replace with safer token generator if possible.
   math.randomseed(os.time())
   local a = {}
   for count = 1, length do
     a[#a+1] = string.char(math.random(65,90))
   end
   return table.concat(a)
 end
</code></pre>
</li>
</ol>
<h1 id="user">User</h1>
<h2 id="user-signup">User Signup</h2>
<p>In this example, you will add the user-signup feature to your solution. Validating a new user requires at least two stepsâ€”creation and activation. A user is unable to log in until activated. Thus, the signup process here will be:</p>
<ol>
<li><p>A user submits their email, name, and password.</p>
</li>
<li><p>Your solution sends the user an email containing an activation link to verify their email address.</p>
</li>
<li><p>The user clicks the activation link to finish the signup process.</p>
</li>
</ol>
<h2 id="user-implementation">User Implementation</h2>
<ol>
<li><p>Prepare an endpoint for user creation to be called when a user submits their email, name, and password.</p>
<p> For use of Murano CLI, create endpoint  <strong>endpoints/api-user-signup.post.lua</strong> and input the following code.</p>
<pre><code class="lang-lua"> --#ENDPOINT POST /api/user/signup
 local email = request.body.email
 local name = request.body.name
 local password = request.body.password

 local ret = User.createUser({
   email = email,
   name = name,
   password = password
 })
 if ret.error ~= nil then
   -- Failed to create user
   response.code = ret.status
   response.message = ret.error
 else
   -- Succeeded in creating user and got the activation code.
   local activation_code = ret
   local domain = Config.solution().domain
   local text = &quot;Hi &quot; .. email .. &quot;,\n&quot;
   text = text .. &quot;Click this link to verify your account:\n&quot;
   -- Include activation link in email
   text = text .. &quot;https://&quot; .. domain .. &quot;/api/verify/&quot; .. activation_code;
   -- Mail to the user for email verification
   Email.send({
     from = &#39;Sample App &lt;mail@exosite.com&gt;&#39;,
     to = email,
     subject = (&quot;Signup on &quot; .. domain),
     text = text
   })
 end
</code></pre>
</li>
<li><p>Create an endpoint for activating users. This endpoint should be the same as the link in the signup email. Users are directed to this endpoint by clicking the link in the email they receive from signup.</p>
<p> For use of Murano CLI, create endpoint <strong>endpoints/api-verify-{code}.get.lua</strong> and put the following code into it.</p>
<pre><code class="lang-lua"> --#ENDPOINT GET /api/verify/{code}
 local ret = User.activateUser({code = request.parameters.code})
 if ret == &#39;OK&#39; then
   response.message = &quot;Sign up succeeded&quot;
 else
   response.code = 401
   response.message = &#39;Sign up failed. Error: &#39; .. ret.message
 end
</code></pre>
</li>
<li><p>Set up a user-signup page as UI.</p>
<p>For use of Murano CLI, create file <strong>files/signup.html</strong> and put the following code into it (on this page, there is a     simple form for input of email, name, and password).</p>
<p>  ```html
  &lt;!DOCTYPE html&gt;</p>
<pre><code> &lt;html lang=&quot;en&quot;&gt;
     &lt;head&gt;
         &lt;meta charset=&quot;utf-8&quot;&gt;
         &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
         &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt;
         &lt;!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags --&gt;
         &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
         &lt;meta name=&quot;author&quot; content=&quot;&quot;&gt;

         &lt;title&gt;Signup&lt;/title&gt;

         &lt;!-- Bootstrap core CSS --&gt;
         &lt;link rel=&quot;stylesheet&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css&quot; integrity=&quot;sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u&quot; crossorigin=&quot;anonymous&quot;&gt;
     &lt;/head&gt;

     &lt;body&gt;

         &lt;div class=&quot;container&quot;&gt;

             &lt;form id=&quot;nav-signup&quot; method=&quot;POST&quot; action=&quot;/api/user/signup&quot; &gt;

                 &lt;div class=&quot;form-group nav-signedout&quot;&gt;
                     &lt;label for=&quot;email&quot;&gt;Email: &lt;/label&gt;
                     &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;email&quot; id=&quot;email&quot; placeholder=&quot;Email&quot; required=&quot;true&quot; /&gt;
                 &lt;/div&gt;
                 &lt;div class=&quot;form-group nav-signedout&quot;&gt;
                     &lt;label for=&quot;name&quot;&gt;Name: &lt;/label&gt;
                     &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;name&quot; id=&quot;name&quot; placeholder=&quot;Name&quot; required=&quot;true&quot; /&gt;
                 &lt;/div&gt;
                 &lt;div class=&quot;form-group nav-signedout&quot;&gt;
                     &lt;label for=&quot;password&quot;&gt;Password: &lt;/label&gt;
                     &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot; id=&quot;password&quot; placeholder=&quot;Password&quot; required=&quot;true&quot; /&gt;
                 &lt;/div&gt;
                 &lt;button type=&quot;submit&quot; class=&quot;btn btn-default nav-signedout&quot; id=&quot;sign-up&quot;&gt;Sign Up&lt;/button&gt;
             &lt;/form&gt;

         &lt;/div&gt;&lt;!-- /.container --&gt;
</code></pre></li>
</ol>
<pre><code>            &lt;!-- Bootstrap core JavaScript
            ================================================== --&gt;
            &lt;!-- Placed at the end of the document so the pages load faster --&gt;
            &lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js&quot; integrity=&quot;sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
            &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js&quot; integrity=&quot;sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
            &lt;script src=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js&quot; integrity=&quot;sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
            &lt;script&gt;
                    $(function(){
                            function signUp() {
                                    console.log(&#39;signing up...&#39;);
                                    $.ajax({
                                            method: &#39;POST&#39;,
                                            url: &#39;/api/user/signup&#39;,
                                            data: JSON.stringify({email: $(&#39;#email&#39;).val(), name: $(&#39;#name&#39;).val(), password: $(&#39;#password&#39;).val()}),
                                            headers: {
                                                    &#39;Content-Type&#39;: &#39;application/json&#39;
                                            },
                                            success: function(data) {
                                                    alert(&quot;You should soon receive an email with a validation token.&quot;);
                                            },
                                            error: function(xhr, textStatus, errorThrown) {
                                                    const errorRes = jQuery.parseJSON(xhr.responseText);
                                                    alert(errorRes.message);
                                            }
                                    });
                            }
                            $(&#39;#nav-signup&#39;).submit(function(){
                                    signUp();
                                    return false;
                            });
                    });
            &lt;/script&gt;
        &lt;/body&gt;
    &lt;/html&gt;
 ```
</code></pre><ol>
<li><p>Deploy the local change by command <strong>murano syncup -V</strong>.</p>
<p>   You should now be able to sign up.</p>
<p>   Go to the user-signup page [<a href="https://&lt;your_domain_name&gt;/signup.html">https://&lt;your_domain_name&gt;/signup.html</a>]. You will see a form for signup.</p>
<p>   <img src="../assets/user-signup.png" alt="User Signup"></p>
<p>   Fill out the form and submit. You will then receive an email for activation.</p>
<p>   <img src="../assets/user-activation-email.png" alt="User Activation"></p>
<p>   Click the link to be directed to your solution. You should receive a success message that user signup is complete.</p>
</li>
</ol>
<h2 id="user-password-reset">User Password Reset</h2>
<p>   Users are only human and may occasionally forget their password. This example will help you implement user-password reset with the following process:</p>
<ol>
<li>A user requests forget-password by email. The solution sends the token to the user.</li>
<li>The user receives the token and then uses the token to set their password directly.</li>
</ol>
<p>Now, you may implement with the following steps.</p>
<ol>
<li><p>You will need an endpoint to be called when a user requests forget-password.</p>
<p> For use of Murano CLI, create endpoint <strong>endpoints/api-forgotten.post.lua</strong> and put the following code into it.</p>
<pre><code class="lang-lua"> --#ENDPOINT POST /api/forgotten

 if request.body.email == nil then
   response.code = 400
   response.message = &quot;Email missing&quot;
   return
 end

 -- Check if the email exists
 local user = find_user_by_email(request.body.email)
 if (user == nil) then
   response.code = 404
   response.message = &quot;User not found&quot;
   return
 end

 -- Generate Token and send email.
 -- That links to reset page, which validates token, and asks for new pasword and resets.

 local resetToken = random_capital_string(50)

 -- Save the token.
 local ret = Keystore.set{key = resetToken, value = user.id}
 if ret.status ~= nil then
   response.code = ret.status
   response.message = ret
   return
 end
 -- Have the Reset Token expire after 24 hours.
 Keystore.command{key = resetToken, command = &#39;EXPIRE&#39;, args = { 24*3600 }}

 local domain = Config.solution().domain
 local text = &quot;Hi &quot; .. user.email .. &quot;,\n&quot;
 text = text .. &quot;Click this link to reset your password\n&quot;
 -- Add Reset Token to query string of the link URL
 text = text .. &quot;https://&quot; .. domain .. &quot;/resetPassword.html?rt=&quot; .. resetToken;
 Email.send({
   from = &#39;Sample App &lt;mail@exosite.com&gt;&#39;,
   to = user.email,
   subject = (&quot;Password reset request from &quot; .. domain),
   text = text
 })
</code></pre>
</li>
<li><p>Create an endpoint for setting a password directly by reset token.</p>
<p> For use of Murano CLI, create endpoint <strong>endpoints/api-resetPassword.post.lua</strong> and put the following code into it.</p>
<pre><code class="lang-lua"> --#ENDPOINT POST /api/resetPassword
 if request.body.resetToken == nil then
   response.code = 400
   response.message = &quot;Missing reset token&quot;
   return
 end

 if request.body.password == nil then
   response.code = 400
   response.message = &quot;Missing new password&quot;
   return
 end

 local found = Keystore.get{key = request.body.resetToken}
 if found.value == nil then
   response.code = found.status
   response.message = &quot;Invalid Token&quot;
   response.code = 400
   return
 end

 local ret = User.resetUserPassword{
   id = found.value,
   password = request.body.password
 }
 if ret.status ~= nil then
   -- Failed to reset password
   response.code = ret.status
   response.message = ret
   return
 end

 Keystore.delete{key = request.body.resetToken}
 -- Reset successfully
 return ret
</code></pre>
<ul>
<li>For UI, there are two pages: one is for users to request by submiting an email; the other is for requesters to set a new password.</li>
</ul>
</li>
<li><p>Create file <strong>files/forgotten.html</strong> and put the following code into it (on this page, there is only an input for email address).</p>
<p> ```html
 &lt;!DOCTYPE html&gt;
 <html lang="en"></p>
<pre><code> &lt;head&gt;
     &lt;meta charset=&quot;utf-8&quot;&gt;
     &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
     &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt;
     &lt;!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags --&gt;
     &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
     &lt;meta name=&quot;author&quot; content=&quot;&quot;&gt;

     &lt;title&gt;Forgot Password&lt;/title&gt;

     &lt;!-- Bootstrap core CSS --&gt;
     &lt;link rel=&quot;stylesheet&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css&quot; integrity=&quot;sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u&quot; crossorigin=&quot;anonymous&quot;&gt;
 &lt;/head&gt;

 &lt;body&gt;

     &lt;div class=&quot;container&quot;&gt;

         &lt;form id=&quot;nav-forgot&quot; method=&quot;POST&quot; action=&quot;/api/forgotten&quot; &gt;

             &lt;div class=&quot;form-group nav-signedout&quot;&gt;
                 &lt;label for=&quot;email&quot;&gt;Email: &lt;/label&gt;
                 &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;email&quot; id=&quot;email&quot; placeholder=&quot;Email&quot; required=&quot;true&quot; /&gt;
             &lt;/div&gt;
             &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot; id=&quot;forgot&quot;&gt;Forgot Password&lt;/button&gt;
         &lt;/form&gt;

     &lt;/div&gt;&lt;!-- /.container --&gt;
</code></pre></li>
</ol>
<pre><code>        &lt;!-- Bootstrap core JavaScript
        ================================================== --&gt;
        &lt;!-- Placed at the end of the document so the pages load faster --&gt;
        &lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js&quot; integrity=&quot;sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js&quot; integrity=&quot;sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js&quot; integrity=&quot;sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script&gt;
                $(function(){
                        function forgotPassword() {
                                $.ajax({
                                        method: &#39;POST&#39;,
                                        url: &#39;/api/forgotten&#39;,
                                        data: JSON.stringify({email: $(&#39;#email&#39;).val()}),
                                        headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                                        success: function(data) {
                                                alert(&quot;You should soon receive an email with a reset link.&quot;);
                                        },
                                        error: function(xhr, textStatus, errorThrown) {
                                                console.log(xhr.responseText);
                                        }
                                });
                        }

                        $(&#39;#nav-forgot&#39;).submit(function(){
                                forgotPassword();
                                return false;
                        });
                });
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
```
</code></pre><ol>
<li><p>Create another page <strong>files/resetPassword.html</strong> and put the following code into it (in this page, there is only an input for new password, but it is assumed to have a Reset Token in the query string when being opened by the requester).</p>
<p> ```html
 &lt;!DOCTYPE html&gt;
 <html lang="en"></p>
<pre><code> &lt;head&gt;
     &lt;meta charset=&quot;utf-8&quot;&gt;
     &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
     &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt;
     &lt;!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags --&gt;
     &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
     &lt;meta name=&quot;author&quot; content=&quot;&quot;&gt;

     &lt;title&gt;Reset Password&lt;/title&gt;

     &lt;!-- Bootstrap core CSS --&gt;
     &lt;link rel=&quot;stylesheet&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css&quot; integrity=&quot;sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u&quot; crossorigin=&quot;anonymous&quot;&gt;
 &lt;/head&gt;

 &lt;body&gt;

     &lt;div class=&quot;container&quot;&gt;

         &lt;form id=&quot;nav-reset-password&quot; method=&quot;POST&quot; action=&quot;/api/resetPassword&quot; &gt;
             &lt;div class=&quot;form-group nav-signedout&quot;&gt;
                 &lt;label for=&quot;password&quot;&gt;New Password: &lt;/label&gt;
                 &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot; id=&quot;password&quot; placeholder=&quot;New Password&quot; required=&quot;true&quot; /&gt;
             &lt;/div&gt;
             &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot; id=&quot;changePassword&quot;&gt;Change&lt;/button&gt;
         &lt;/form&gt;

     &lt;/div&gt;&lt;!-- /.container --&gt;
</code></pre></li>
</ol>
<pre><code>        &lt;!-- Bootstrap core JavaScript
        ================================================== --&gt;
        &lt;!-- Placed at the end of the document so the pages load faster --&gt;
        &lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js&quot; integrity=&quot;sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js&quot; integrity=&quot;sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js&quot; integrity=&quot;sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script&gt;
            $(function(){
                        var resetToken = null;

                        function changePassword() {
                            $.ajax({
                                    method: &#39;POST&#39;,
                                    url: &#39;/api/resetPassword&#39;,
                                    data: JSON.stringify({
                                            resetToken: resetToken,
                                            password: $(&#39;#password&#39;).val()
                                    }),
                                    headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                                    success: function(data) {
                                            alert(&#39;Changed&#39;);
                                    },
                                    error: function(xhr, textStatus, errorThrown) {
                                            try {
                                                    const errorRes = jQuery.parseJSON(xhr.responseText);
                                                    alert(errorRes.message);
                                            } catch (e){
                                                    alert(xhr.responseText);
                                            }
                                    }
                            });
                    }

                    $(&#39;#nav-reset-password&#39;).submit(function(){
                            changePassword();
                            return false;
                    });

                    function getParameterByName(name, url) {
                            if (!url) {
                                    url = window.location.href;
                            }
                            name = name.replace(/[\[\]]/g, &quot;\\$&amp;&quot;);
                            var regex = new RegExp(&quot;[?&amp;]&quot; + name + &quot;(=([^&amp;#]*)|&amp;|#|$)&quot;),
                                    results = regex.exec(url);
                            if (!results) return null;
                            if (!results[2]) return &#39;&#39;;
                            return decodeURIComponent(results[2].replace(/\+/g, &quot; &quot;));
                    }

                    resetToken = getParameterByName(&#39;rt&#39;);

            });
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
```
</code></pre><ol>
<li><p>Deploy the local change by command <strong>murano syncup -V</strong>.</p>
<p> A password can now be reset.</p>
<ol>
<li><p>Go to forgotten page [<a href="https://&lt;your_domain_name&gt;/forgotten.html">https://&lt;your_domain_name&gt;/forgotten.html</a>]. Submit an email address of an existing user.</p>
<p> <img src="../assets/user-forget-password.png" alt="User Forget Password"></p>
</li>
<li><p>Receive the email and click the link to set new password.</p>
<p>   <img src="../assets/user-reset-password-email.png" alt="User Reset Password Email"></p>
<p>   <img src="../assets/user-reset-password.png" alt="User Reset Password"></p>
</li>
<li><p>Once you get message &quot;Changed&quot;. The user password has been changed.</p>
</li>
</ol>
</li>
</ol>
<h2 id="user-authentication">User Authentication</h2>
<p>The process of solution user identification is:</p>
<ol>
<li><p>A user uses their <strong>email</strong> and <strong>password</strong> to get a token representing an authenticated user and has an associated time-to-live(ttl).</p>
</li>
<li><p>A token can be used to get the user basic information such as user.id, user.email, user.name, etc.</p>
</li>
</ol>
<h2 id="user-login">User Login</h2>
<p>This example will help you implement the user-login feature, which will display a user login and profile page.</p>
<ol>
<li><p>Create an endpoint to be called when a user submits their email and password.</p>
<p> For use of Murano CLI, create endpoint <strong>endpoints/api-session-login.post.lua</strong> and input the following code.</p>
<pre><code class="lang-lua"> --#ENDPOINT POST /api/session/login
 -- Clear browser cookie to logout current user
 response.headers = {
   [&quot;Set-Cookie&quot;] = &quot;sid=; path=/;&quot;
 }
 -- Authenticate by email and password
 local ret = User.getUserToken({
   email = request.body.email,
   password = request.body.password
 })
 -- If email and password match, it will return a token.
 if ret.error ~= nil then
    response.code = 401
   response.message = &quot;Auth failed&quot;
 else
   local domain = Config.solution().domain
   response.code = 303
     -- Save token as current user in browser cookie
     response.headers = {
       [&quot;Set-Cookie&quot;] = &quot;sid=&quot; .. tostring(ret)..&quot;; path=/;&quot;,
       [&quot;Location&quot;] = &quot;https://&quot; .. domain .. &quot;/api/session/user&quot;
     }
 end
</code></pre>
</li>
<li><p>Create an endpoint for returning current user info. This can be used to check logged-in users for access restrictions.</p>
<p> For use of Murano CLI, create endpoint  <strong>endpoints/api-session-user.get.lua</strong> and input the following code.</p>
<pre><code class="lang-lua"> --#ENDPOINT GET /api/session/user
 local user = get_current_user(request)
 if user ~= nil and user.id ~= nil then
   response.headers = {
     [&quot;Cache-Control&quot;] = &#39;no-cache&#39;,
   }
   response.message = user
 else
   response.code = 400
   response.message = &quot;Session invalid&quot;
 end
</code></pre>
</li>
<li><p>For the login page, create file <strong>files/login.html</strong> and input the following code (in this page, there is a form for submitting email and password).</p>
<p> ```html
 &lt;!DOCTYPE html&gt;
 <html lang="en"></p>
<pre><code> &lt;head&gt;
     &lt;meta charset=&quot;utf-8&quot;&gt;
     &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
     &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt;
     &lt;!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags --&gt;
     &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
     &lt;meta name=&quot;author&quot; content=&quot;&quot;&gt;

     &lt;title&gt;Login&lt;/title&gt;

     &lt;!-- Bootstrap core CSS --&gt;
     &lt;link rel=&quot;stylesheet&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css&quot; integrity=&quot;sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u&quot; crossorigin=&quot;anonymous&quot;&gt;
 &lt;/head&gt;

 &lt;body&gt;

     &lt;div class=&quot;container&quot;&gt;

         &lt;form id=&quot;nav-login&quot; method=&quot;POST&quot; action=&quot;/api/session/login&quot; &gt;

             &lt;div class=&quot;form-group nav-signedout&quot;&gt;
                 &lt;label for=&quot;email&quot;&gt;Email: &lt;/label&gt;
                 &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;email&quot; id=&quot;email&quot; placeholder=&quot;Email&quot; required=&quot;true&quot; /&gt;
             &lt;/div&gt;
             &lt;div class=&quot;form-group nav-signedout&quot;&gt;
                 &lt;label for=&quot;password&quot;&gt;Password: &lt;/label&gt;
                 &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot; id=&quot;password&quot; placeholder=&quot;Password&quot; required=&quot;true&quot; /&gt;
             &lt;/div&gt;
             &lt;button type=&quot;submit&quot; class=&quot;btn btn-default nav-signedout&quot; id=&quot;login&quot;&gt;Login&lt;/button&gt;
         &lt;/form&gt;

     &lt;/div&gt;&lt;!-- /.container --&gt;
</code></pre></li>
</ol>
<pre><code>        &lt;!-- Bootstrap core JavaScript
        ================================================== --&gt;
        &lt;!-- Placed at the end of the document so the pages load faster --&gt;
        &lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js&quot; integrity=&quot;sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js&quot; integrity=&quot;sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js&quot; integrity=&quot;sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script&gt;
                $(function(){
                        function login() {
                                console.log(&#39;logging in...&#39;);
                                $.ajax({
                                        method: &#39;POST&#39;,
                                        url: &#39;/api/session/login&#39;,
                                        data: JSON.stringify({email: $(&#39;#email&#39;).val(), password: $(&#39;#password&#39;).val()}),
                                        headers: {
                                                &#39;Content-Type&#39;: &#39;application/json&#39;
                                        },
                                        success: function(data) {
                                                window.location.href = &#39;profile.html&#39;;
                                        },
                                        error: function(xhr, textStatus, errorThrown) {
                                                alert(xhr.responseText);
                                        }
                                });
                        }
                        $(&#39;#nav-login&#39;).submit(function(){
                                login();
                                return false;
                        });
                });
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
```
</code></pre><ol>
<li><p>For the profile page, create file <strong>files/profile.html</strong> and input the following code.</p>
<p> ```html
 &lt;!DOCTYPE html&gt;
 <html lang="en"></p>
<pre><code> &lt;head&gt;
     &lt;meta charset=&quot;utf-8&quot;&gt;
     &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
     &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt;
     &lt;!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags --&gt;
     &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
     &lt;meta name=&quot;author&quot; content=&quot;&quot;&gt;

     &lt;title&gt;Login&lt;/title&gt;

     &lt;!-- Bootstrap core CSS --&gt;
     &lt;link rel=&quot;stylesheet&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css&quot; integrity=&quot;sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u&quot; crossorigin=&quot;anonymous&quot;&gt;
 &lt;/head&gt;

 &lt;body&gt;

     &lt;div class=&quot;container&quot;&gt;
                     &lt;h2&gt;My Profile&lt;/h2&gt;
                     &lt;table id=&quot;user-info&quot; class=&quot;table table-hover&quot;&gt;
                             &lt;tbody&gt;
                             &lt;/tbody&gt;
                     &lt;/table&gt;
                     &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; id=&quot;Logout&quot;&gt;Logout&lt;/button&gt;
     &lt;/div&gt;&lt;!-- /.container --&gt;
</code></pre></li>
</ol>
<pre><code>        &lt;!-- Bootstrap core JavaScript
        ================================================== --&gt;
        &lt;!-- Placed at the end of the document so the pages load faster --&gt;
        &lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js&quot; integrity=&quot;sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js&quot; integrity=&quot;sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js&quot; integrity=&quot;sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script&gt;
                $(function(){
                        function checkSession() {
                                $.ajax({
                                        method: &#39;GET&#39;,
                                        url: &#39;/api/session/user&#39;,
                                        success: function(user) {
                                                loadProfileDetails(user);
                                        },
                                        error: function(xhr, textStatus, errorThrown) {
                                                console.log(&quot;Session check failed.&quot;);
                                                window.location.href = &quot;login.html&quot;;
                                        }
                                });
                        }

                        function loadProfileDetails(user) {
                                $(Object.keys(user)).each(function(index, name){
                                        const title = $(&quot;&lt;th /&gt;&quot;).text(name);
                                        const value = $(&quot;&lt;td /&gt;&quot;).text(user[name]);
                                        const row = $(&quot;&lt;tr /&gt;&quot;).append(title).append(value);
                                        $(&#39;#user-info tbody&#39;).append(row);
                                });
                        }

                        function logout() {
                                $.ajax({
                                        method: &#39;POST&#39;,
                                        url: &#39;/api/session/login&#39;,
                                        data: JSON.stringify({email: &quot;inavlid&quot;, password: &quot;invalid&quot;}),
                                        headers: {
                                                &#39;Content-Type&#39;: &#39;application/json&#39;
                                        },
                                        error: function(xhr, textStatus, errorThrown) {
                                                window.location.href = &quot;login.html&quot;;
                                        }
                                });
                        }

                        $(&#39;#Logout&#39;).click(function() {
                            logout();
                        });
                        checkSession();
                });
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
```
</code></pre><ol>
<li><p>Deploy the local change by command <strong>murano syncup -V</strong>.</p>
<p> You are now able to log in.</p>
<ol>
<li><p>Go to the login page [<a href="https://&lt;your_domain_name&gt;/login.html">https://&lt;your_domain_name&gt;/login.html</a>]. Submit your email and password.</p>
<p> <img src="../assets/user-login.png" alt="User Login"></p>
</li>
<li><p>With the correct email and password, you should log in successfully and be redirected to the profile page     [<a href="https://&lt;your_domain_name&gt;/profile.html">https://&lt;your_domain_name&gt;/profile.html</a>].</p>
<p> <img src="../assets/user-profile.png" alt="User Profile"></p>
</li>
<li><p>Click the logout button, and you will be redirected to the login page.</p>
</li>
</ol>
</li>
</ol>
<h1 id="role">Role</h1>
<h2 id="role-creation">Role Creation</h2>
<p>Assumption:
You want to provide differentiated info of a user depending on different roles. An owner should be able to see all info while a guest is restricted to partial info. Here is the code you can use to initiate roles for this example.</p>
<p>Please create endpoint <strong>endpoints/_init.get.lua</strong>.</p>
<p>If your solution does not have it, then put/merge the following code into it.</p>
<pre><code class="lang-lua">--#ENDPOINT GET /_init
-- Create a role represents &#39;owner&#39;
local owner_role = {role_id = &quot;owner&quot;}
User.createRole(owner_role)

-- Create a role represents &#39;guest&#39;
local guest_role = {role_id = &quot;guest&quot;}
User.createRole(guest_role)

-- Add parameter &#39;infoUserId&#39; to specify user for info retrieve, thus you can assign roles with specific user IDs later on.
local add_owner_info_user_id = {
  role_id = &quot;owner&quot;,
  body = {
    {
      name = &quot;infoUserId&quot;
    }
  }
}
User.addRoleParam(add_owner_info_user_id)

local add_guest_info_user_id = {
  role_id = &quot;guest&quot;,
  body = {
    {
      name = &quot;infoUserId&quot;
    }
  }
}
User.addRoleParam(add_guest_info_user_id)
</code></pre>
<p>To create roles above, please deploy by command <strong>murano syncup -V</strong> and then go to endpoint [https://<your_domain_name>/_init] for executing the code.</p>
<h2 id="role-assignment">Role Assignment</h2>
<p>Assumption:
Bearing on Role-Creation, you have created two roles (<strong>owner</strong> and <strong>guest</strong>) for differentiating user info retrieved. Now you can grant differing access by role assignement. In this example, a user is assumed to be assigned roles once created.</p>
<p>Please modify the file <strong>endpoints/api-user-signup.post.lua</strong> from User-Signup example and input the following code.</p>
<pre><code class="lang-lua">--#ENDPOINT POST /api/user/signup
local email = request.body.email
local name = request.body.name
local password = request.body.password

local ret = User.createUser({
  email = email,
  name = name,
  password = password
})
if ret.error ~= nil then
  -- Failed to create user
  response.code = ret.status
  response.message = ret.error
else
  -- Succeeded in user creation and got the activation code.

  -- Assign roles to this new user
  local new_user = find_user_by_email(email)
  local assign_info_user_id = {
    id = new_user.id,
    roles = {
      {
        -- Assign role &#39;owner&#39; to let the created user be owner of himself
        role_id = &quot;owner&quot;,
        parameters = {
          {
            name = &quot;infoUserId&quot;,
            value = new_user.id
          }
        }
      },
      {
        -- Assign role &#39;guest&#39; to let the created user be guest to other users.
        role_id = &quot;guest&quot;,
        parameters = {
          {
            name = &quot;infoUserId&quot;,
            value = {
              type = &quot;wildcard&quot;
            }
          }
        }
      }
    }
  }
  User.assignUser(assign_info_user_id)


  local activation_code = ret
  local domain = Config.solution().domain
  local text = &quot;Hi &quot; .. email .. &quot;,\n&quot;
  text = text .. &quot;Click this link to verify your account:\n&quot;
  -- Include activation link in email
  text = text .. &quot;https://&quot; .. domain .. &quot;/api/verify/&quot; .. activation_code;
  -- Mail to the user for email verification
  Email.send({
    from = &#39;Sample App &lt;mail@exosite.com&gt;&#39;,
    to = email,
    subject = (&quot;Signup on &quot; .. domain),
    text = text
  })
end
</code></pre>
<p>Please deploy the local change again by command <strong>murano syncup -V</strong>.</p>
<p>Now, every new user signing up through <strong>/api/user/signup</strong> will be granted user info access.</p>
<p>To see how it works, move on to the next example.</p>
<h2 id="role-check">Role Check</h2>
<p>Assumption:
Bearing on Role-Assignment, a new user will be granted differing user info access. This example will focus on how you check a resource access by assigned roles. You will implement a page for email query. The info returned depends on which roles the current user has.</p>
<p>The following is a table listing the details available for each role.</p>
<table>
<thead>
<tr>
<th>Access Role</th>
<th>User Info Retrieved</th>
</tr>
</thead>
<tbody>
<tr>
<td>Logged-in User is Owner</td>
<td>user.id, user.name, user.email, user.status, user.creation_date, user.roles</td>
</tr>
<tr>
<td>Logged-in User is Guest</td>
<td>user.email, user.creation_date</td>
</tr>
<tr>
<td>Logged-in User without relevant roles</td>
<td>user.email</td>
</tr>
<tr>
<td>Public / Not Logged-in User</td>
<td>Message &quot;Email <user.email> has already been taken.&quot;</td>
</tr>
</tbody>
</table>
<ol>
<li><p>Create an endpoint for returning user info when submitting an email.</p>
<p> Please create endpoint <strong>endpoints/api-user-info-{email}.get.lua</strong> and input the following code.</p>
<pre><code class="lang-lua"> --#ENDPOINT GET /api/user/info/{email}
 local current_user = get_current_user(request)
 local info_user = find_user_by_email(request.parameters.email)

 if (current_user == nil) then
   -- There is no current user
   if (info_user == nil) then
     response.message = &quot;Email &quot; .. request.parameters.email .. &quot; is available.&quot;
   else
     response.message = &quot;Email &quot; .. request.parameters.email .. &quot; has already been taken.&quot;
   end
   return
 end

 if (info_user == nil) then
   response.message = &quot;Not Found&quot;
   response.code = 404
   return
 end

 local check_current_user_has_owner_role = {
   id = current_user.id,
   role_id = &quot;owner&quot;,
   parameter_name = &quot;infoUserId&quot;,
   parameter_value = info_user.id
 }
 local owner_role_check_result = User.hasUserRoleParam(check_current_user_has_owner_role)
 if (owner_role_check_result.error == nil) then
   -- is owner
   local user_info_for_owner = info_user
   -- get roles of the user
   local roles_of_user = User.listUserRoles({id = info_user.id})
   -- add further info about roles of the user
   user_info_for_owner.roles = roles_of_user
   response.message = user_info_for_owner
   return
 end

 local check_current_user_has_guest_role = {
   id = current_user.id,
   role_id = &quot;guest&quot;,
   parameter_name = &quot;infoUserId&quot;,
   parameter_value = info_user.id
 }
 local guest_role_check_result = User.hasUserRoleParam(check_current_user_has_guest_role)
 if (guest_role_check_result.error == nil) then
   local user_info_for_guest = {
     email = info_user.email,
     creation_date = info_user.creation_date
   }
   response.message = user_info_for_guest
   return
 end

 response.message = {
   email = info_user.email
 }
</code></pre>
</li>
<li><p>Create a query page for submiting an email address.
 Please create file <strong>files/queryEmail.html</strong> and put the following code into it.
 ```html
 &lt;!DOCTYPE html&gt;
 <html lang="en"></p>
<pre><code> &lt;head&gt;
     &lt;meta charset=&quot;utf-8&quot;&gt;
     &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
     &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt;
     &lt;!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags --&gt;
     &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
     &lt;meta name=&quot;author&quot; content=&quot;&quot;&gt;

     &lt;title&gt;Query Email&lt;/title&gt;

     &lt;!-- Bootstrap core CSS --&gt;
     &lt;link rel=&quot;stylesheet&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css&quot; integrity=&quot;sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u&quot; crossorigin=&quot;anonymous&quot;&gt;
 &lt;/head&gt;

 &lt;body&gt;

     &lt;div class=&quot;container&quot;&gt;

         &lt;form id=&quot;nav-query-email&quot;&gt;
             &lt;div class=&quot;form-group nav-signedout&quot;&gt;
                 &lt;label for=&quot;email&quot;&gt;Email: &lt;/label&gt;
                 &lt;input type=&quot;email&quot; class=&quot;form-control&quot; name=&quot;email&quot; id=&quot;email&quot; placeholder=&quot;Email&quot; required=&quot;true&quot; /&gt;
             &lt;/div&gt;
             &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot; id=&quot;query_email&quot;&gt;Query&lt;/button&gt;
         &lt;/form&gt;
                     &lt;div class=&quot;container&quot;&gt;
                             &lt;h2&gt;Info of Email&lt;/h2&gt;
                             &lt;table id=&quot;user-info&quot; class=&quot;table table-hover&quot;&gt;
                                     &lt;tbody&gt;
                                     &lt;/tbody&gt;
                             &lt;/table&gt;
                     &lt;/div&gt;

     &lt;/div&gt;&lt;!-- /.container --&gt;
</code></pre></li>
</ol>
<pre><code>        &lt;!-- Bootstrap core JavaScript
        ================================================== --&gt;
        &lt;!-- Placed at the end of the document so the pages load faster --&gt;
        &lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js&quot; integrity=&quot;sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js&quot; integrity=&quot;sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js&quot; integrity=&quot;sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
        &lt;script&gt;
                $(function(){
                        function queryEmail() {
                                $(&#39;#user-info tbody&#39;).text(&#39;&#39;);
                                $.ajax({
                                        method: &#39;GET&#39;,
                                        url: &#39;/api/user/info/&#39;+$(&#39;#email&#39;).val(),
                                        success: function(info) {
                                                if (jQuery.type(info) === &#39;string&#39;) {
                                                    loadInfo({&#39;-&#39;: info});
                                                    return;
                                                }
                                                loadInfo(info);
                                        },
                                        error: function(xhr, textStatus, errorThrown) {
                                                loadInfo({&#39;-&#39;: xhr.responseText});
                                        }
                                });
                        }

                        function loadInfo(info) {
                                $(Object.keys(info)).each(function(index, name){
                                        const titleField = $(&quot;&lt;th /&gt;&quot;).text(name);
                                        const value = jQuery.type(info[name]) === &#39;array&#39; ? JSON.stringify(info[name]) : info[name];
                                        const valueField = $(&quot;&lt;td /&gt;&quot;).text(value);
                                        const row = $(&quot;&lt;tr /&gt;&quot;).append(titleField).append(valueField);
                                        $(&#39;#user-info tbody&#39;).append(row);
                                });
                        }


                        $(&#39;#nav-query-email&#39;).submit(function() {
                            queryEmail();
                            return false;
                        });
                });
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
```

Now you can deploy the local change and then try on the query page.

1. Go to [https://&amp;lt;your_domain_name&amp;gt;/queryEmail.html] without login. Query with an existing email address.

    ![Query Email by Public](../assets/query-email-by-public.png)

2. Next, sign up at [https://&lt;your_domain_name&gt;/signup.html] from example User-Signup for getting a new user that has been assigned with roles.

3. Log in with the new user at [https://&amp;lt;your_domain_name&amp;gt;/login.html] from example User-Login and then back to [https://&amp;lt;your_domain_name&amp;gt;/queryEmail.html] to query with your email address. Because the current user has owner role, it will return full info.

    ![Query Email by Owner](../assets/query-email-by-owner.png)

4. Lastly, query with another existing email addressâ€”as a guest you will only get partial info.

    ![Query Email by Guest](../assets/query-email-by-guest.png)
</code></pre><h2 id="user-permission">User Permission</h2>
<p>User permission is based on <a href="https://en.wikipedia.org/wiki/Role-based_access_control">RBAC</a>.
In this system, there are three concrete elements: &rsquo;role&rsquo;, &rsquo;user&rsquo;, and &rsquo;endpoint&rsquo;. According to RBAC, you can control a user&rsquo;s access to endpoint with the concept below:</p>
<ol>
<li>Assign endpoint to role</li>
<li>Assign role to user</li>
<li>User can access the endpoint of their role</li>
</ol>
<p><img src="../assets/user_1.png" alt="User Diagram 1"></p>
<p>However, URL can be different in variable practically. For example, &rsquo;<em>device/1/info</em>&rsquo; and &rsquo;<em>device/2/info</em>&rsquo; are different literally but can be considered the same endpoint. You do not want to create two endpoints for such a difference. That is why the fourth element called &rsquo;parameter&rsquo; is added.</p>
<p>&rsquo;Parameter&rsquo; represents a specific resource by name and value. It is marked as {&lt;parameter_name&gt;} in endpoint. Here, the creation of only one endpoint &rsquo;device/{rid}/info&rsquo; for &rsquo;<em>device/1/info</em>&rsquo; and &rsquo;<em>device/2/info</em>&rsquo; is needed.
When user permission is granted, it is necessary to specify parameters for each role assignment.</p>
<p><img src="../assets/user_2.png" alt="User Diagram 2"></p>
<p>If you want to grant &rsquo;UserA&rsquo; access to &rsquo;<em>device/1/info</em>&rsquo;, you can:</p>
<ol>
<li>Create a role called &rsquo;Viewer&rsquo;.</li>
<li>Add parameter definition &rsquo;rid&rsquo; to role &rsquo;Viewer&rsquo;, which means parameter &rsquo;rid&rsquo; is available in role &rsquo;Viewer&rsquo;.</li>
<li>Assign endpoint &rsquo;<em>device/{rid}/info</em>&rsquo; to role &rsquo;Viewer&rsquo;.</li>
<li>Assign role &rsquo;Viewer&rsquo; with parameter &rsquo;rid&rsquo;(name) = 1(value) to &rsquo;UserA&rsquo;.</li>
<li>Now UserA is allowed access to &rsquo;<em>device/1/info</em>&rsquo; when you check their permission.</li>
</ol>
<h2 id="storage-per-user">Storage Per User</h2>
<p>The provided storage per user stores data by key-value format. Since a user&rsquo;s properties are only email and name, you can put more individual information in storage (e.g., address, birthday, etc.).</p>
<h1 id="-span-id-head_tutorial_example-tutorial-example-in-scripting-system-span-"><span id="head_tutorial_example">Tutorial Example in Scripting System</span></h1>
<p>Assume you are running a parking application.
There are two major roles in your system. One: the driver wants to park their vehicle. Two: the parking lot/garage charges drivers for parking.</p>
<p>To separate their permission, you should create at least two roles.</p>
<h6 id="-span-id-eg_createrole-span-"><span id="eg_createRole"></span></h6>
<pre><code class="lang-lua">-- Create role &#39;vehicle_driver&#39; for driver
local role_vehicle_driver = {
    [&quot;role_id&quot;] = &quot;vehicle_driver&quot;
}
User.createRole(role_vehicle_driver)

-- Create role &#39;parking_area_manager&#39;
local role_parking_area_manager = {
    [&quot;role_id&quot;] = &quot;parking_area_manager&quot;
}
User.createRole(role_parking_area_manager)
</code></pre>
<p>Suppose you have two users:</p>
<p><strong>User_Parking_Area</strong> is in role &rsquo;parking_area_manager&rsquo; and has unique ID = <strong>1</strong>.</p>
<h6 id="-span-id-eg_createuser-span-"><span id="eg_createUser"></span></h6>
<pre><code class="lang-lua">-- Create User_Parking_Area
local new_user = {
    [&quot;name&quot;] = &quot;User_Parking_Area&quot;,
    [&quot;email&quot;] = &quot;demo_parking_area@exosite.com&quot;,
    [&quot;password&quot;] = &quot;demo777&quot;
}
local activation_code = User.createUser(new_user)
</code></pre>
<h6 id="-span-id-eg_activateuser-span-"><span id="eg_activateUser"></span></h6>
<pre><code class="lang-lua">-- Need to activate user after creating
local parameters = {
    [&quot;code&quot;] = activation_code
}
User.activateUser(parameters)
</code></pre>
<p><strong>User_Vehicle</strong> is in role &rsquo;vehicle_driver&rsquo; and has unique ID = <strong>2</strong>.</p>
<pre><code class="lang-lua">-- Create User_Vehicle
local new_user = {
    [&quot;name&quot;] = &quot;User_Vehicle&quot;,
    [&quot;email&quot;] = &quot;demo_vehicle@exosite.com&quot;,
    [&quot;password&quot;] = &quot;demo777&quot;
}
local activation_code = User.createUser(new_user)

-- Activate User_Vehicle
local parameters = {
    [&quot;code&quot;] = activation_code
}
User.activateUser(parameters)
</code></pre>
<p>In this tutorial, you will assume each driver has exactly one vehicle. This is a simplification that allows you to respect the User Management focus of this tutorial. You will represent the driver&#39;s vehicle data in a keystore record derived from the user&#39;s ID.</p>
<h6 id="-span-span-"><span></span></h6>
<pre><code class="lang-lua">--- Store User_Vehicle&#39;s license plate number
local driver_id = 2 -- User ID of User_Vehicle
parameters = {
    [&quot;key&quot;] = &quot;Driver_&quot;..driver_id..&quot;_Vehicle_License_Plate_Number&quot;,
    [&quot;value&quot;] = &quot;QA-7712&quot;
}
Keystore.set(parameters)

-- Initialize User_Vehicle&#39;s parking start time
parameters = {
    [&quot;key&quot;] = &quot;Driver_&quot;..driver_id..&quot;_Parking_Start_Time&quot;,
    [&quot;value&quot;] = &quot;0000-00-00 00:00:00&quot; -- current parking start time
}
Keystore.set(parameters)
</code></pre>
<h3 id="scenario-list-control">Scenario: List Control</h3>
<p>First, support an endpoint for parking areas to manage their parking spaces. This endpoint is expected to list unique IDs of parking spaces.</p>
<pre><code class="lang-lua">-- Create endpoint for listing parking spaces of parking area
local list_parking_space_endpoint = {
    [&quot;method&quot;] = &quot;GET&quot;,
    [&quot;end_point&quot;] = &quot;list/{parkingAreaID}/parkingSpace&quot; -- This endpoint contains a parameter name &#39;parkingAreaID&#39;
}
User.createPermission(list_parking_space_endpoint)

-- Assign endpoint to role &#39;parking_area_manager&#39;, so parking area managers can access it.
local endpoints = {
    [&quot;method&quot;] = &quot;GET&quot;,
    [&quot;end_point&quot;] = &quot;list/{parkingAreaID}/parkingSpace&quot;
}
User.addRolePerm({[&quot;role_id&quot;] = &quot;parking_area_manager&quot;, [&quot;body&quot;] = endpoints})
</code></pre>
<p>To let <strong>User_Parking_Area</strong> access <em>&#39;GET list/1/parkingSpace&#39;</em>, grant <strong>User_Parking_Area</strong> permisson on &#39;parkingAreaID&#39; = 1 in role &#39;parking_area_manager&#39;.</p>
<pre><code class="lang-lua">-- We should add parameter definition before assigning roles with new parameter name.
local param_definitions = {
    {
        [&quot;name&quot;] = &quot;parkingAreaID&quot;
    }
}
User.addRoleParam({[&quot;role_id&quot;] = &quot;parking_area_manager&quot;,  [&quot;body&quot;] = param_definitions})

-- Grant User_Parking_Area parameter &#39;parkingAreaID&#39; = 1 in role &#39;parking_area_manager&#39;
local roles_assigned = {
    {
        [&quot;role_id&quot;] = &quot;parking_area_manager&quot;,
        [&quot;parameters&quot;] = {
            {
                [&quot;name&quot;] = &quot;parkingAreaID&quot;,
                [&quot;value&quot;] = 1
            }
        }
    }
}
User.assignUser({[&quot;id&quot;] = 1, [&quot;roles&quot;] = roles_assigned})
</code></pre>
<p>Now <strong>User_Parking_Area</strong> can access <em>&#39;GET list/1/parkingSpace&#39;</em>.</p>
<p>Next, make the list returned in response.</p>
<p>Assume there are two parking spaces in <strong>User_Parking_Area</strong>. Each parking space has a device RID. Devices can detect the status of a parking space. You can make <strong>User_Parking_Area</strong> have device RIDs by assigning roles.</p>
<pre><code class="lang-lua">-- We should add parameter definition before assigning roles with new parameter name.
local param_definitions = {
    [&quot;role_id&quot;] = &quot;parking_area_manager&quot;,
    [&quot;body&quot;] = {
        {
            [&quot;name&quot;] = &quot;spaceRID&quot; -- device RID
        }
    }
}
User.addRoleParam(param_definitions)

-- Grant User_Parking_Area access to his parking space RIDs
local roles_assigned = {
    {
        [&quot;role_id&quot;] = &quot;parking_area_manager&quot;,
        [&quot;parameters&quot;] = {
            {
                [&quot;name&quot;] = &quot;spaceRID&quot;,
                [&quot;value&quot;] = &quot;d2343hbcc1232sweee12&quot; -- first parking space RID
             },
             {
                [&quot;name&quot;] = &quot;spaceRID&quot;,
                [&quot;value&quot;] = &quot;a34feh709a234e232xd21&quot; -- second parking space RID
             }
        }
    }
}
User.assignUser({[&quot;id&quot;] = 1, [&quot;roles&quot;] = roles_assigned})
</code></pre>
<p>After roles assignment, you can return a paginated list of &rsquo;spaceRID&rsquo; when <strong>User_Parking_Area</strong> accesses <em>&#39;GET list/1/parkingSpace&#39;</em>.</p>
<h6 id="-span-id-eg_listuserroleparamvalues-span-"><span id="eg_listUserRoleParamValues"></span></h6>
<pre><code class="lang-lua">local parameters = {
    [&quot;id&quot;] = 1, -- User ID of User_Parking_Area
    [&quot;role_id&quot;] = &quot;parking_area_manager&quot;,
    [&quot;parameter_name&quot;] = &quot;spaceRID&quot;,
    [&quot;offset&quot;] = 0, -- offset for pagination
    [&quot;limit&quot;] = 10 -- limit for pagination
}
local result = User.listUserRoleParamValues(parameters)
response.message = result.items -- return the list of RID
</code></pre>
<h3 id="scenario-endpoint-access-control">Scenario: Endpoint Access Control</h3>
<p>Second, support an endpoint for drivers to look for a vacant parking space. Drivers can query a number of vacancy in every parking area while each parking area manager is restricted to their own.</p>
<h6 id="-span-id-eg_createpermission-span-"><span id="eg_createPermission"></span></h6>
<pre><code class="lang-lua">-- Create endpoint for querying vacant parking space
local available_space_endpoint = {
    [&quot;method&quot;] = &quot;GET&quot;,
    [&quot;end_point&quot;] = &quot;query/{parkingAreaID}/availableSpace&quot; -- The endpoint contains a parameter name &#39;parkingAreaID&#39;.
}
User.createPermission(available_space_endpoint)
</code></pre>
<h6 id="-span-id-eg_addroleperm-span-"><span id="eg_addRolePerm"></span></h6>
<pre><code class="lang-lua">-- Assign the endpoint to roles &#39;vehicle_driver&#39; and &#39;parking_area_manager&#39;, so drivers and parking area managers can access the endpoint.
local endpoints = {
    {
        [&quot;method&quot;] = &quot;GET&quot;,
        [&quot;end_point&quot;] = &quot;query/{parkingAreaID}/availableSpace&quot;
    }
}
-- Let drivers access this endpoint
User.addRolePerm({[&quot;role_id&quot;] = &quot;vehicle_driver&quot;, [&quot;body&quot;] = endpoints})
-- Let parking area managers access this endpoint
User.addRolePerm({[&quot;role_id&quot;] = &quot;parking_area_manager&quot;, [&quot;body&quot;] = endpoints})
</code></pre>
<p>To let <strong>User_Parking_Area</strong> access <em>&#39;GET query/1/availableSpace&#39;</em>, <strong>User_Parking_Area</strong> should have parameter &#39;parkingAreaID&#39; = 1 in role &#39;parking_area_manager&#39;. Since they have been assigned it before, there is no need to assign again.</p>
<p>To let <strong>User_Vehicle</strong> access <em>&#39;GET query/\</em>/availableSpace&#39;<em>, you should grant <strong>User_Vehicle</strong> permission on &#39;parkingAreaID&#39; = </em> in role &#39;vehicle_driver&#39;.</p>
<h6 id="-span-id-eg_addroleparam-span-"><span id="eg_addRoleParam"></span></h6>
<pre><code class="lang-lua">-- To role &#39;vehicle_driver&#39;, parameter name &#39;parkingAreaID&#39; is new. Before assigning roles with new parameter name, you need to add parameter definition.
local param_definitions = {
    {
        [&quot;name&quot;] = &quot;parkingAreaID&quot;
    }
}
User.addRoleParam({[&quot;role_id&quot;] = &quot;vehicle_driver&quot;,  [&quot;body&quot;] = param_definitions})
</code></pre>
<h6 id="-span-id-eg_assignuser-span-"><span id="eg_assignUser"></span></h6>
<pre><code class="lang-lua">-- Grant User_Vehicle all value of parkingAreaID in role &#39;vehicle_driver&#39;
local roles_assigned = {
    {
        [&quot;role_id&quot;] = &quot;vehicle_driver&quot;,
        [&quot;parameters&quot;] = {
            {
                [&quot;name&quot;] = &quot;parkingAreaID&quot;,
                [&quot;value&quot;] = {
                    [&quot;type&quot;] = &quot;wildcard&quot; -- this format represents all values
                }
            }
        }
    }
}
User.assignUser({[&quot;id&quot;] = 2, [&quot;roles&quot;] = roles_assigned})
</code></pre>
<p>Now you can prepare the number returned in response.</p>
<p>You already know there are two parking spaces in <strong>User_Parking_Area</strong>. Assume that each parking area is managed by one manager. Thus, info can be stored in keystore storage with the key derived from the manager&#39;s ID.</p>
<pre><code class="lang-lua">-- Set number of vacancy info for User_Parking_Area
local manager_id = 1 -- User ID of User_Parking_Area
parameters = {
    [&quot;key&quot;] = &quot;Parking_Area_&quot;..manager_id..&quot;_Number_of_Vacancy&quot;,
    [&quot;value&quot;] = 2 -- Assuming currently there is no vehicle parked in User_Parking_Area.
}
Keystore.set(parameters) -- We store value by Keystore service.
</code></pre>
<p>When permitted user accesses <em>&#39;GET  query/1/availableSpace&#39;</em>, you can return the number.</p>
<pre><code class="lang-lua">-- Get number of vanacy of User_Parking_Area
local manager_id = 1 -- User ID of User_Parking_Area
parameters = {
    [&quot;key&quot;] = &quot;Parking_Area_&quot;..manager_id..&quot;_Number_of_Vacancy&quot;
}
local number = Keystore.get(parameters)
response.message = number
</code></pre>
<p>The background process of permission check when the user accesses endpoint can be replicated as follows:</p>
<h6 id="-span-id-eg_hasuserperm-span-"><span id="eg_hasUserPerm"></span></h6>
<pre><code class="lang-lua">-- Check if User_Vehicle can access GET query/1/availableSpace.
local check_permission = {
    [&quot;id&quot;] = 2, -- User ID of User_Vehicle
    [&quot;perm_id&quot;] = &quot;GET/query/{parkingAreaID}/availableSpace&quot;, -- {method}/{end_point}
    [&quot;parameters&quot;] = {
        &quot;parkingAreaID::1&quot; -- Specifies value 1 for parameter &#39;parkingAreaID&#39; in endpoint
    }
}
local result = User.hasUserPerm(check_permission)
</code></pre>
<p>Because <strong>User_Vehicle</strong> has been assigned with all values of &rsquo;parkingAreaID&rsquo; in role &rsquo;vehicle_driver&rsquo;, variable &rsquo;result&rsquo; is expected to be &rsquo;OK&rsquo;.</p>
<pre><code class="lang-lua">-- Check if User_Parking_Area can access &#39;GET query/1/availableSpace&#39;.
local check_param = {
    [&quot;id&quot;] = 1, -- User ID of User_Parking_Area
    [&quot;perm_id&quot;] = &quot;GET/query/{parkingAreaID}/availableSpace&quot;, -- {method}/{end_point}
    [&quot;parameters&quot;] = {
        &quot;parkingAreaID::1&quot; -- Specifies value 1 for parameter &#39;parkingAreaID&#39; in endpoint
    }
}
local result = User.hasUserPerm(check_param)
</code></pre>
<p>Because <strong>User_Parking_Area</strong> has been assigned with &rsquo;parkingAreaID = 1&rsquo; in role &rsquo;parking_area_manager&rsquo;, variable &rsquo;result&rsquo; is expected to be &rsquo;OK&rsquo;.</p>
<h3 id="scenario-application-of-user-storage-and-endpoint-access-control">Scenario: Application of User-storage and Endpoint-access-control</h3>
<p>An endpoint for parking area managers to query info of a vehicle, such as parking time or license plate number, is also supported. Each parking area manager can only see info of vehicles parked in their spaces.</p>
<pre><code class="lang-lua">-- Create endpoint &#39;GET query/{parkingAreaID}/parkingVehicle/{vehicleID}/info&#39;
local vehicle_info_endpoint = {
    [&quot;method&quot;] = &quot;GET&quot;,
    [&quot;end_point&quot;] = &quot;query/{parkingAreaID}/parkingVehicle/{vehicleID}/info&quot;
}
User.createPermission(vehicle_info_endpoint)

-- Assign endpoint to role &#39;parking_area_manager&#39;, so parking area managers can access this endpoint.
local endpoints_assigned = {
    {
        [&quot;method&quot;] = &quot;GET&quot;,
        [&quot;end_point&quot;] = &quot;query/{parkingAreaID}/parkingVehicle/{vehicleID}/info&quot; -- This endpoint contains a parameter name &#39;vehicleID&#39;
    }
}
User.addRolePerm({[&quot;role_id&quot;] = &quot;parking_area_manager&quot;, [&quot;body&quot;] = endpoints_assigned})

-- Add parameter definition &#39;vehicleID&#39; to role &#39;parking_area_manager&#39; for assigning role &#39;parking_area_manager&#39; with parameter &#39;vehicleID&#39;
local param_definitions = {
    {
        [&quot;name&quot;] = &quot;vehicleID&quot;
    }
}
User.addRoleParam({[&quot;role_id&quot;] = &quot;parking_area_manager&quot;,  [&quot;body&quot;] = param_definitions})
</code></pre>
<p>When <strong>User_Vehicle</strong> parks in <strong>User_Parking_Area</strong> (detected by device), <strong>User_Parking_Area</strong> should have the right to see info of <strong>User_Vehicle</strong>.</p>
<pre><code class="lang-lua">-- Since User_Parking_Area already has &#39;parkingAreaID&#39; = 1 in role &#39;parking_area_manager&#39;, we only need to assign role &#39;parking_area_manager&#39; with extra parameter &#39;vehicleID&#39; = 2 to User_Parking_Area.
local roles_assigned = {
    {
        [&quot;role_id&quot;] = &quot;parking_area_manager&quot;,
        [&quot;parameters&quot;] = {
            {
                [&quot;name&quot;] = &quot;vehicleID&quot;,
                [&quot;value&quot;] = 2 -- User ID of User_Vehicle
            }
        }
    }
}
User.assignUser({[&quot;id&quot;] = 1, [&quot;roles&quot;] = roles_assigned})
</code></pre>
<h6 id="-span-id-eg_updateuserdata-span-"><span id="eg_updateUserData"></span></h6>
<pre><code class="lang-lua">-- Add parking info for User_Vehicle
local driver_id = 2 -- User ID of User_Vehicle
parameters = {
    [&quot;key&quot;] = &quot;Driver_&quot;..driver_id..&quot;_Parking_Start_Time&quot;,
    [&quot;value&quot;] = &quot;2016-08-30 08:10:10&quot;
}
Keystore.set(parameters)
</code></pre>
<p>For info of the space <strong>User_Vehicle</strong> is parking at, you can create another parameter &#39;parkingSpaceRID&#39; to store relationship by role assignment.</p>
<pre><code class="lang-lua">-- Create parameter definition for new parameter.
local param_definitions = {
    [&quot;role_id&quot;] = &quot;vehicle_driver&quot;,
    [&quot;body&quot;] = {
        {
            [&quot;name&quot;] = &quot;parkingSpaceRID&quot; -- device RID of parking space
        }
    }
}
User.addRoleParam(param_definitions)
-- User_Vehicle is parking at space &#39;d2343hbcc1232sweee1&#39;.
local roles_assigned = {
    {
        [&quot;role_id&quot;] = &quot;vehicle_driver&quot;,
        [&quot;parameters&quot;] = {
            {
                [&quot;name&quot;] = &quot;parkingSpaceRID&quot;,
                [&quot;value&quot;] = &quot;d2343hbcc1232sweee1&quot; -- device RID of parking space
            }
        }
    }
}
User.assignUser({[&quot;id&quot;] = 2, [&quot;roles&quot;] = roles_assigned})
</code></pre>
<p>Because parking space &rsquo;d2343hbcc1232sweee1&rsquo; is occupied, you should also update the number of vacancy of <strong>User_Parking_Area</strong>.</p>
<pre><code class="lang-lua">-- Get current number of vacancy of User_Parking_Area
local manager_id = 1
parameters = {
    [&quot;key&quot;] = &quot;Parking_Area_&quot;..manager_id..&quot;_Number_of_Vacancy&quot;
}
local latest_number = Keystore.get(parameters)

-- Update number of vacancy to latest
parameters = {
    [&quot;key&quot;] = &quot;Parking_Area_&quot;..manager_id..&quot;_Number_of_Vacancy&quot;,
    [&quot;value&quot;] = latest_number - 1 -- User_Vehicle just occupied one parking space.
}
Keystore.set(parameters)
</code></pre>
<p>Now <strong>User_Parking_Area</strong> can access <em>&#39;GET query/1/parkingVehicle/2/info&#39;</em> to get parking info of <strong>User_Vehicle</strong>.</p>
<h6 id="-span-span-"><span></span></h6>
<pre><code class="lang-lua">-- Get parking info of User_Vehicle
local driver_id = 2 -- User ID of User_Vehicle
parameters = {
    [&quot;key&quot;] = &quot;Driver_&quot;..driver_id..&quot;_Parking_Start_Time&quot;
}
local parking_start_time = Keystore.get(parameters)

parameters = {
    [&quot;key&quot;] = &quot;Driver_&quot;..driver_id..&quot;_Vehicle_License_Plate_Number&quot;
}
local license_plate_number = Keystore.get(parameters)

-- Find parking space User_Vehicle is parking at

parameters = {
    [&quot;id&quot;] = 2, -- User ID of User_Vehicle
    [&quot;role_id&quot;] = &quot;vehicle_driver&quot;,
    [&quot;parameter_name&quot;] = &quot;parkingSpaceRID&quot;
}
local values = User.listUserRoleParamValues(parameters)
local parking_space_rid = values[1]

-- response with parking info
response.message = {
    [&quot;parking_start_time&quot;] = parking_start_time,
    [&quot;license_plate_number&quot;] = license_plate_number,
    [&quot;parking_space_rid&quot;] = parking_space_rid
}
</code></pre>
<p>When <strong>User_Vehicle</strong> is going to leave, <strong>User_Parking_Area</strong> can charge them according to the parking time.</p>
<p>After <strong>User_Vehicle</strong> leaves, remove <strong>User_Vehicle</strong> from the parking list of <strong>User_Parking_Area</strong> and update relevant info.</p>
<pre><code class="lang-lua">local roles_removed = {
    [&quot;id&quot;] = 1, -- User ID of User_Parking_Area
    [&quot;role_id&quot;] = &quot;parking_area_manager&quot;,
    [&quot;parameter_name&quot;] = &quot;vehicleID&quot;,
    [&quot;parameter_value&quot;] = 2 -- User ID of User_Vehicle
}
User.deassignUserParam(roles_removed)

-- Also remove relationship between User_Vehicle and parking space
local roles_removed = {
    [&quot;id&quot;] = 2, -- User ID of User_Vehicle
    [&quot;role_id&quot;] = &quot;vehicle_driver&quot;,
    [&quot;parameter_name&quot;] = &quot;parkingSpaceRID&quot;,
    [&quot;parameter_value&quot;] = &quot;d2343hbcc1232sweee1&quot;
}
User.deassignUserParam(roles_removed)

-- Update parking info of User_Vehicle
local driver_id = 2 -- User ID of User_Vehicle
parameters = {
    [&quot;key&quot;] = &quot;Driver_&quot;..driver_id..&quot;_Parking_Start_Time&quot;,
    [&quot;value&quot;] = &quot;0000-00-00 00:00:00&quot;
}
Keystore.set(parameters)

-- Update number of vacancy of User_Parking_Area
local manager_id = 1
parameters = {
    [&quot;key&quot;] = &quot;Parking_Area_&quot;..manager_id..&quot;_Number_of_Vacancy&quot;
}
local latest_number = Keystore.get(parameters)

parameters = {
    [&quot;key&quot;] = &quot;Parking_Area_&quot;..manager_id..&quot;_Number_of_Vacancy&quot;,
    [&quot;value&quot;] = latest_number + 1 -- User_Vehicle just left.
}
Keystore.set(parameters)
</code></pre>
<p><strong>User_Parking_Area</strong> cannot access <em>&#39;GET query/1/parkingVehicle/2/info&#39;</em> any longer since <strong>User_Vehicle</strong> is not in their parking list.</p>
<pre><code class="lang-lua">-- Background process of checking if User_Parking_Area can access &#39;GET query/1/parkingVehicle/2/info&#39;.

local check_permission = {
    [&quot;id&quot;] = 1, -- User ID of User_Parking_Area
    [&quot;perm_id&quot;] = &quot;GET/query/{parkingAreaID}/parkingVehicle/{vehicleID}/info&quot;, -- {method}/{end_point}
    [&quot;parameters&quot;] = {
        &quot;parkingAreaID::1&quot;, -- Specifies value 1 for parameter &#39;parkingAreaID&#39; in endpoint
        &quot;vehicleID::2&quot; -- Specifies value 2 for parameter &#39;vehicleID&#39; in endpoint
    }
}
local result = User.hasUserPerm(check_permission)
</code></pre>
<p>Because currently <strong>User_Parking_Area</strong> does not have parameter &rsquo;vehicleID&rsquo; = 2 in role &rsquo;parking_area_manager&rsquo;, it is expected to get result.status == 403.</p>
<h1 id="-span-id-head_reference-reference-for-example-span-"><span id="head_reference">Reference for Example</span></h1>
<ul>
<li><p>RBAC</p>
<ul>
<li>User<ul>
<li><a href="#eg_createUser">User.createUser()</a></li>
<li><a href="#eg_activateUser">User.activateUser()</a></li>
</ul>
</li>
<li>Role<ul>
<li><a href="#eg_createRole">User.createRole()</a></li>
<li><a href="#eg_caddRoleParam">User.addRoleParam()</a></li>
</ul>
</li>
<li>Endpoint<ul>
<li><a href="#eg_createPermission">User.createPermission()</a></li>
</ul>
</li>
<li>Role-Endpoint Relation<ul>
<li><a href="#eg_addRolePerm">User.addRolePerm()</a></li>
</ul>
</li>
<li>Role-User Relation<ul>
<li><a href="#eg_assignUser">User.assignUser()</a></li>
<li><a href="#eg_deassignUserParam">User.deassignUserParam()</a></li>
<li><a href="#eg_hasUserPerm">User.hasUserPerm()</a></li>
<li><a href="#eg_listUserRoleParamValues">User.listUserRoleParamValues()</a></li>
</ul>
</li>
</ul>
</li>
<li><p>User Storage</p>
<ul>
<li><a href="#eg_createUserData">User.createUserData()</a></li>
<li><a href="#eg_updateUserData">User.updateUserData()</a></li>
<li><a href="#eg_getUserData">User.getUserData()</a></li>
</ul>
</li>
</ul>

    </div>
</div> <!-- end main content row -->
</div>

<div class="footer">
    <div class="footer-container center-block">
        <div class="row">
            <div class="col-sm-3">
                <img class="footer-logo" src="/assets/logo-symbol.png" id="logo-icon">
            </div>
            <!-- products menu -->
            <div class=" col-sm-2 nav-menu">
                <h4 class="widget-title">Products</h4>
                <ul id="menu-product" class="menu">
                    <li><a href="https://exosite.com/platform/">Platform</a></li>
                    <li><a href="https://exosite.com/resources/exositeready/">ExositeReady&trade;</a></li>
                </ul>
            </div>
            <!-- solutions menu -->
            <!--<div class="col-sm-2 nav-menu">-->
                <!--<h4 class="widget-title">Solutions</h4>-->
                <!--<ul id="menu-product" class="menu">-->
                    <!--<li><a href="#">IoT 101</a></li>-->
                    <!--<li><a href="#">Concept Validation</a></li>-->
                    <!--<li><a href="#">Proof of Feasibility</a></li>-->
                <!--</ul>-->
            <!--</div>-->
            <!-- resources menu -->
            <div class="col-sm-2 nav-menu">
                <h4 class="widget-title">Resources</h4>
                <ul id="menu-product" class="menu">
                    <li><a href="https://exosite.com/casestudies/">Case Studies</a></li>
                    <li><a href="https://exosite.com/whitepapers/">White Papers</a></li>
                    <li><a href="https://exosite.com/blog/">Blog</a></li>
                    <li><a href="https://exosite.com/resources/developer-resources/">Developer Resources</a></li>
                </ul>
            </div>
            <!-- tools menu -->
            <div class="col-sm-2 nav-menu">
                <h4 class="widget-title">Tools</h4>
                <ul id="menu-product" class="menu">
                    <li><a href="https://community.exosite.com/">Community</a></li>
                    <li><a href="https://support.exosite.com/hc/en-us">Support</a></li>
                    <li><a href="https://status.exosite.com/">Status</a></li>
                </ul>
            </div>
            <!-- company menu -->
            <div class="col-sm-2 nav-menu">
                <h4 class="widget-title">Company</h4>
                <ul id="menu-product" class="menu">
                    <li><a href="https://exosite.com/about/">About</a></li>
                    <li><a href="https://exosite.com/newsroom/">News & Events</a></li>
                    <li><a href="https://exosite.com/careers/">Careers</a></li>
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-3 col-sm-offset-2 footer-info">
                <p><a href="https://exosite.com/privacy-policy/">Privacy Policy</a> | <a
                        href="https://exosite.com/murano-terms-conditions/">Terms & Conditions</a></p>
                <p>All rights reserved exosite.com &copy;2017</p>
            </div>
            <div class="col-sm-2 language-select">
                <a href="#" class="btn"><img src="/assets/american-flag.png">Language</a>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>


<!-- Custom -->
<script src='/assets/main.js'></script>

</body>
</html>
